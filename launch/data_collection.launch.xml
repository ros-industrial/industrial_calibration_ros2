<?xml version="1.0"?>
<launch>
  <arg name="target_mount_frame" default="base_link"/>
  <arg name="target_frame" default="cal_target_frame"/>
  <arg name="camera_mount_frame" default="tool0"/>
  <arg name="camera_frame" default="camera_color_optical_frame"/>
  <arg name="save_path" default="/tmp/calibration"/>
  <arg name="config_file" default="$(find-pkg-share industrial_calibration_ros)/config/target_detector_config.yaml"/>
  <arg name="sync_time" default="1.0"/>
  <arg name="image_topic" default="/camera/color/image_raw"/>
  <arg name="static_camera" default="false"/>
  <arg name="headless" default="false"/>

  <!-- Static camera case -->
  <let name="base_frame" value="$(var camera_mount_frame)" if="$(var static_camera)"/>
  <let name="tool_frame" value="$(var target_mount_frame)" if="$(var static_camera)"/>
  <!-- Moving camera case-->
  <let name="base_frame" value="$(var target_mount_frame)" unless="$(var static_camera)"/>
  <let name="tool_frame" value="$(var camera_mount_frame)" unless="$(var static_camera)"/>

  <!-- Target detector node -->
  <node name="target_detector_node" pkg="industrial_calibration_ros" exec="industrial_calibration_ros_target_detector" output="screen">
    <param name="config_file" value="$(var config_file)"/>
    <remap from="image" to="$(var image_topic)"/>
  </node>

  <!-- Image trigger node-->
  <node name="image_trigger" pkg="industrial_calibration_ros" exec="image_trigger.py">
    <param name="sync_time" value="$(var sync_time)"/>
    <remap from="image" to="image_detected"/>
    <remap from="image_out" to="image_detected_trigger"/>
  </node>

  <!-- Data collector -->
  <node name="data_collection_node" pkg="industrial_calibration_ros" exec="data_collection_node.py" output="screen">
    <param name="base_frame" value="$(var base_frame)"/>
    <param name="tool_frame" value="$(var tool_frame)"/>
    <param name="save_path" value="$(var save_path)"/>
    <remap from="image" to="image_detected_trigger"/>
  </node>

  <!-- Rviz -->
  <group unless="$(var headless)">
    <node pkg="rviz2" exec="rviz2" args="-d $(find-pkg-share industrial_calibration_ros)/config/extrinsic_hand_eye_calibration.rviz">
      <param name="camera_mount_frame" value="$(var camera_mount_frame)"/>
      <param name="camera_frame" value="$(var camera_frame)"/>
      <param name="target_mount_frame" value="$(var target_mount_frame)"/>
      <param name="target_frame" value="$(var target_frame)"/>
    </node>
  </group>
</launch>
